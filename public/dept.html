<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Civisense | Department Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <link rel="stylesheet" href="dashboard.css">
  
  <style>
    .dept-header { 
      background: #2563eb; 
      color: white; 
      padding: 30px 0; 
      border-radius: 0 0 20px 20px; 
      margin-bottom: 30px;
    }
    .task-card { 
      background: white; 
      border-radius: 15px; 
      border-left: 6px solid #2563eb; 
      transition: transform 0.2s;
    }
    .task-card:hover { transform: scale(1.02); }
    .status-pill { font-size: 0.75rem; padding: 4px 12px; border-radius: 50px; }
  </style>
</head>
<body class="bg-light">

  <div class="dept-header shadow">
    <div class="container d-flex justify-content-between align-items-center">
      <div>
        <h1 id="dept-title" class="fw-bold mb-0">Department Dashboard</h1>
        <p class="mb-0 opacity-75">Active complaints for your team</p>
      </div>
      <div class="dropdown">
        <button class="btn btn-light dropdown-toggle" type="button" id="deptSelector" data-bs-toggle="dropdown">
          Switch Department
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item" onclick="changeDept('Roads & Infrastructure')">Roads & Infrastructure</button></li>
          <li><button class="dropdown-item" onclick="changeDept('Water Supply')">Water Supply</button></li>
          <li><button class="dropdown-item" onclick="changeDept('Electricity')">Electricity</button></li>
          <li><button class="dropdown-item" onclick="changeDept('Waste Management')">Waste Management</button></li>
          <li><button class="dropdown-item" onclick="changeDept('Public Safety')">Public Safety</button></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row g-4" id="task-container">
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Store selected department in LocalStorage to persist across refreshes
    let selectedDept = localStorage.getItem('civicDept') || 'Water Supply';

    async function loadTasks() {
      document.getElementById('dept-title').innerText = selectedDept;
      
      try {
        const res = await fetch(`/api/dept/${encodeURIComponent(selectedDept)}`);
        const tasks = await res.json();
        
        const container = document.getElementById('task-container');
        container.innerHTML = '';

        if (tasks.length === 0) {
          container.innerHTML = `<div class="text-center py-5">
            <i class="bi bi-emoji-smile fs-1 text-muted"></i>
            <h4 class="text-muted mt-3">All clear! No pending issues.</h4>
          </div>`;
          return;
        }

        tasks.forEach(task => {
          const card = document.createElement('div');
          card.className = 'col-md-6 col-lg-4';
          card.innerHTML = `
            <div class="task-card p-4 shadow-sm h-100">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted small">ID: #${task.id}</span>
                <span class="status-pill ${task.status === 'Resolved' ? 'bg-success text-white' : 'bg-warning text-dark'}">
                  ${task.status}
                </span>
              </div>
              <h5 class="fw-bold">${task.category}</h5>
              <p class="text-secondary small mb-4">${task.description}</p>
              <div class="d-grid">
                ${task.status !== 'Resolved' ? 
                  `<button class="btn btn-outline-success btn-sm" onclick="markResolved(${task.id})">Mark as Resolved</button>` : 
                  `<button class="btn btn-success btn-sm disabled"><i class="bi bi-check-circle"></i> Completed</button>`
                }
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    async function markResolved(id) {
      const res = await fetch('/api/dept/status', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id, status: 'Resolved' })
      });

      if (res.ok) {
        loadTasks();
      }
    }

    function changeDept(name) {
      selectedDept = name;
      localStorage.setItem('civicDept', name);
      loadTasks();
    }

    // Initial load
    loadTasks();
  </script>
</body>
</html>