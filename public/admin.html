<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CivicOne | Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="fw-bold mb-4">Admin Dashboard</h1>
        <div class="table-responsive bg-white p-3 rounded shadow-sm">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Photo</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Assign Department</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const departments = ['Water Supply', 'Roads & Infrastructure', 'Electricity', 'Waste Management'];

        async function loadAdminData() {
            const res = await fetch('/api/admin/all-issues');
            const issues = await res.json();
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';

            issues.forEach(issue => {
                const imgTag = issue.image_path 
                    ? `<img src="${issue.image_path}" width="60" class="rounded" style="cursor:pointer" onclick="window.open('${issue.image_path}')">` 
                    : '<span class="text-muted small">No Image</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${issue.id}</td>
                    <td>${imgTag}</td>
                    <td>${issue.category}</td>
                    <td><span class="badge bg-info text-dark">${issue.status}</span></td>
                    <td>
                        <select class="form-select form-select-sm" id="dept-${issue.id}">
                            <option value="Unassigned">Choose Dept...</option>
                            ${departments.map(d => `<option value="${d}" ${issue.department === d ? 'selected' : ''}>${d}</option>`).join('')}
                        </select>
                    </td>
                    <td><button class="btn btn-sm btn-dark" onclick="assign(${issue.id})">Update</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function assign(id) {
            const dept = document.getElementById(`dept-${id}`).value;
            await fetch('/api/admin/assign', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, department: dept })
            });
            alert('Assigned Successfully');
            loadAdminData();
        }

        loadAdminData();
    </script>
</body>
</html>